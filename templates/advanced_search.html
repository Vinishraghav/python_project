{% extends 'base.html' %} {% block title %}Advanced Search - Tour Van Booking{%
endblock %} {% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-md-4 mb-4">
      <!-- Advanced Search Form -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-search me-2"></i>Advanced Search
          </h5>
        </div>
        <div class="card-body">
          <form id="advanced-search-form">
            <!-- Location Search -->
            <div class="mb-3">
              <label for="location" class="form-label">Location</label>
              <div class="input-group">
                <span class="input-group-text"
                  ><i class="fas fa-map-marker-alt"></i
                ></span>
                <input
                  type="text"
                  class="form-control"
                  id="location"
                  name="location"
                  placeholder="Enter city or state"
                />
              </div>
            </div>

            <!-- Date Range -->
            <div class="row mb-3">
              <div class="col-6">
                <label for="start_date" class="form-label">Start Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="start_date"
                  name="start_date"
                />
              </div>
              <div class="col-6">
                <label for="end_date" class="form-label">End Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="end_date"
                  name="end_date"
                />
              </div>
            </div>

            <!-- Price Range -->
            <div class="mb-3">
              <label class="form-label">Price Range (per day)</label>
              <div class="row">
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    id="min_price"
                    name="min_price"
                    placeholder="Min $"
                    min="0"
                  />
                </div>
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    id="max_price"
                    name="max_price"
                    placeholder="Max $"
                    min="0"
                  />
                </div>
              </div>
              <div class="price-range-slider mt-2">
                <input
                  type="range"
                  class="form-range"
                  id="price_range"
                  min="0"
                  max="500"
                  step="10"
                  value="250"
                />
                <div class="d-flex justify-content-between small text-muted">
                  <span>$0</span>
                  <span id="price_display">$250</span>
                  <span>$500+</span>
                </div>
              </div>
            </div>

            <!-- Capacity -->
            <div class="mb-3">
              <label for="capacity" class="form-label"
                >Number of Passengers</label
              >
              <select class="form-select" id="capacity" name="capacity">
                <option value="">Any capacity</option>
                <option value="2">2 passengers</option>
                <option value="4">4 passengers</option>
                <option value="6">6 passengers</option>
                <option value="8">8+ passengers</option>
              </select>
            </div>

            <!-- Van Category -->
            <div class="mb-3">
              <label for="category" class="form-label">Van Category</label>
              <select class="form-select" id="category" name="category">
                <option value="">All categories</option>
                <option value="Budget">Budget</option>
                <option value="Urban">Urban</option>
                <option value="Adventure">Adventure</option>
                <option value="Family">Family</option>
                <option value="Luxury">Luxury</option>
              </select>
            </div>

            <!-- Fuel Type -->
            <div class="mb-3">
              <label for="fuel_type" class="form-label">Fuel Type</label>
              <select class="form-select" id="fuel_type" name="fuel_type">
                <option value="">Any fuel type</option>
                <option value="Gasoline">Gasoline</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
                <option value="Hybrid">Hybrid</option>
              </select>
            </div>

            <!-- Transmission -->
            <div class="mb-3">
              <label for="transmission" class="form-label">Transmission</label>
              <select class="form-select" id="transmission" name="transmission">
                <option value="">Any transmission</option>
                <option value="Manual">Manual</option>
                <option value="Automatic">Automatic</option>
              </select>
            </div>

            <!-- Amenities -->
            <div class="mb-3">
              <label class="form-label">Amenities</label>
              <div class="amenities-checkboxes">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="wifi"
                    name="amenities"
                    value="WiFi"
                  />
                  <label class="form-check-label" for="wifi">WiFi</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="kitchen"
                    name="amenities"
                    value="Kitchen"
                  />
                  <label class="form-check-label" for="kitchen">Kitchen</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="shower"
                    name="amenities"
                    value="Shower"
                  />
                  <label class="form-check-label" for="shower">Shower</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="toilet"
                    name="amenities"
                    value="Toilet"
                  />
                  <label class="form-check-label" for="toilet">Toilet</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="tv"
                    name="amenities"
                    value="TV"
                  />
                  <label class="form-check-label" for="tv"
                    >TV/Entertainment</label
                  >
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="ac"
                    name="amenities"
                    value="Air Conditioning"
                  />
                  <label class="form-check-label" for="ac"
                    >Air Conditioning</label
                  >
                </div>
              </div>
            </div>

            <!-- Rating Filter -->
            <div class="mb-3">
              <label for="min_rating" class="form-label">Minimum Rating</label>
              <select class="form-select" id="min_rating" name="min_rating">
                <option value="">Any rating</option>
                <option value="3">3+ stars</option>
                <option value="4">4+ stars</option>
                <option value="4.5">4.5+ stars</option>
              </select>
            </div>

            <!-- Search Buttons -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-2"></i>Search Vans
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="clear-filters"
              >
                <i class="fas fa-times me-2"></i>Clear Filters
              </button>
              <button
                type="button"
                class="btn btn-outline-info"
                id="save-search"
              >
                <i class="fas fa-bookmark me-2"></i>Save Search
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Saved Searches -->
      <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="fas fa-bookmark me-2"></i>Saved Searches
          </h6>
        </div>
        <div class="card-body">
          <div id="saved-searches-list">
            <p class="text-muted small mb-0">No saved searches yet</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <!-- Search Results Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="h4 mb-1">Search Results</h2>
          <p class="text-muted mb-0" id="results-count">
            Showing all available vans
          </p>
        </div>
        <div class="d-flex">
          <!-- Sort Options -->
          <div class="dropdown me-2">
            <button
              class="btn btn-outline-secondary dropdown-toggle"
              type="button"
              id="sortDropdown"
              data-bs-toggle="dropdown"
            >
              <i class="fas fa-sort me-1"></i>Sort by
            </button>
            <ul class="dropdown-menu">
              <li>
                <a
                  class="dropdown-item sort-option"
                  href="#"
                  data-sort="price-low"
                  >Price: Low to High</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item sort-option"
                  href="#"
                  data-sort="price-high"
                  >Price: High to Low</a
                >
              </li>
              <li>
                <a class="dropdown-item sort-option" href="#" data-sort="rating"
                  >Highest Rated</a
                >
              </li>
              <li>
                <a class="dropdown-item sort-option" href="#" data-sort="newest"
                  >Newest First</a
                >
              </li>
            </ul>
          </div>

          <!-- View Options -->
          <div class="btn-group" role="group">
            <button
              type="button"
              class="btn btn-outline-secondary active"
              id="grid-view"
            >
              <i class="fas fa-th"></i>
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              id="list-view"
            >
              <i class="fas fa-list"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div id="search-results">
        <div class="row" id="vans-grid">
          <!-- Van cards will be populated here by JavaScript -->
        </div>
      </div>

      <!-- No Results Message -->
      <div id="no-results" class="text-center py-5" style="display: none">
        <div class="mb-3">
          <i class="fas fa-search fa-3x text-muted"></i>
        </div>
        <h5>No vans found</h5>
        <p class="text-muted">
          Try adjusting your search criteria to find more options.
        </p>
        <button class="btn btn-outline-primary" id="reset-search">
          <i class="fas fa-redo me-2"></i>Reset Search
        </button>
      </div>

      <!-- Loading Spinner -->
      <div id="loading-spinner" class="text-center py-5" style="display: none">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Searching for vans...</p>
      </div>
    </div>
  </div>
</div>

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Save Search</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="save-search-form">
          <div class="mb-3">
            <label for="search-name" class="form-label">Search Name</label>
            <input
              type="text"
              class="form-control"
              id="search-name"
              name="search_name"
              placeholder="e.g., Weekend Adventure Vans"
              required
            />
          </div>
          <div class="mb-3">
            <label for="search-description" class="form-label"
              >Description (optional)</label
            >
            <textarea
              class="form-control"
              id="search-description"
              name="search_description"
              rows="2"
              placeholder="Brief description of this search"
            ></textarea>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="email-alerts"
              name="email_alerts"
            />
            <label class="form-check-label" for="email-alerts">
              Email me when new vans match this search
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="confirm-save-search">
          Save Search
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .amenities-checkboxes {
    max-height: 150px;
    overflow-y: auto;
  }

  .van-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .van-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .price-range-slider {
    position: relative;
  }

  #price_display {
    font-weight: bold;
    color: var(--primary-color);
  }

  .rating-stars {
    color: #ffc107;
  }

  .saved-search-item {
    padding: 0.5rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .saved-search-item:hover {
    background-color: #f8f9fa;
  }

  .list-view .van-card {
    margin-bottom: 1rem;
  }

  .list-view .van-card .card-body {
    display: flex;
    align-items: center;
  }

  .list-view .van-image {
    width: 150px;
    height: 100px;
    object-fit: cover;
    margin-right: 1rem;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize search
    loadVans();
    loadSavedSearches();

    // Price range slider
    const priceRange = document.getElementById("price_range");
    const priceDisplay = document.getElementById("price_display");

    priceRange.addEventListener("input", function () {
      priceDisplay.textContent = "$" + this.value;
    });

    // Advanced search form
    const searchForm = document.getElementById("advanced-search-form");
    searchForm.addEventListener("submit", function (e) {
      e.preventDefault();
      performSearch();
    });

    // Clear filters
    document
      .getElementById("clear-filters")
      .addEventListener("click", function () {
        searchForm.reset();
        priceDisplay.textContent = "$250";
        loadVans();
      });

    // Save search
    document
      .getElementById("save-search")
      .addEventListener("click", function () {
        const modal = new bootstrap.Modal(
          document.getElementById("saveSearchModal")
        );
        modal.show();
      });

    // Confirm save search
    document
      .getElementById("confirm-save-search")
      .addEventListener("click", function () {
        saveSearch();
      });

    // Sort options
    document.querySelectorAll(".sort-option").forEach((option) => {
      option.addEventListener("click", function (e) {
        e.preventDefault();
        const sortBy = this.getAttribute("data-sort");
        sortResults(sortBy);
      });
    });

    // View toggle
    document.getElementById("grid-view").addEventListener("click", function () {
      toggleView("grid");
    });

    document.getElementById("list-view").addEventListener("click", function () {
      toggleView("list");
    });
  });

  function loadVans() {
    showLoading(true);

    // Simulate API call
    setTimeout(() => {
      fetch("/api/vans")
        .then((response) => response.json())
        .then((data) => {
          displayVans(data.vans);
          updateResultsCount(data.vans.length);
          showLoading(false);
        })
        .catch((error) => {
          console.error("Error loading vans:", error);
          showLoading(false);
        });
    }, 500);
  }

  function performSearch() {
    showLoading(true);

    const formData = new FormData(
      document.getElementById("advanced-search-form")
    );
    const searchParams = new URLSearchParams();

    // Add form data to search params
    for (let [key, value] of formData.entries()) {
      if (value) {
        searchParams.append(key, value);
      }
    }

    // Add selected amenities
    const selectedAmenities = [];
    document
      .querySelectorAll('input[name="amenities"]:checked')
      .forEach((checkbox) => {
        selectedAmenities.push(checkbox.value);
      });

    if (selectedAmenities.length > 0) {
      searchParams.append("amenities", selectedAmenities.join(","));
    }

    fetch("/api/search-vans?" + searchParams.toString())
      .then((response) => response.json())
      .then((data) => {
        displayVans(data.vans);
        updateResultsCount(data.vans.length);
        showLoading(false);
      })
      .catch((error) => {
        console.error("Error searching vans:", error);
        showLoading(false);
      });
  }

  function displayVans(vans) {
    const vansGrid = document.getElementById("vans-grid");
    const noResults = document.getElementById("no-results");

    if (vans.length === 0) {
      vansGrid.innerHTML = "";
      noResults.style.display = "block";
      return;
    }

    noResults.style.display = "none";

    vansGrid.innerHTML = vans
      .map(
        (van) => `
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card van-card border-0 shadow-sm h-100">
          <img src="${
            van.image || "/static/img/default-van.jpg"
          }" class="card-img-top" alt="${
          van.name
        }" style="height: 200px; object-fit: cover;">
          <div class="card-body">
            <h5 class="card-title">${van.name}</h5>
            <p class="card-text text-muted small">${van.description}</p>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="rating-stars">
                ${"★".repeat(Math.floor(van.rating || 0))}${"☆".repeat(
          5 - Math.floor(van.rating || 0)
        )}
                <span class="text-muted small">(${
                  van.total_reviews || 0
                })</span>
              </div>
              <span class="badge bg-primary">${van.category}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong class="text-primary">$${van.price}/day</strong>
                <div class="small text-muted">
                  <i class="fas fa-map-marker-alt"></i> ${van.location}
                </div>
              </div>
              <div class="btn-group-vertical btn-group-sm">
                <a href="/van-details/${
                  van.id
                }" class="btn btn-outline-primary btn-sm">View Details</a>
                <button class="btn btn-outline-secondary btn-sm favorite-btn" data-van-id="${
                  van.id
                }">
                  <i class="far fa-heart"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `
      )
      .join("");

    // Add favorite button listeners
    document.querySelectorAll(".favorite-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        toggleFavorite(this.getAttribute("data-van-id"), this);
      });
    });
  }

  function updateResultsCount(count) {
    const resultsCount = document.getElementById("results-count");
    resultsCount.textContent = `Showing ${count} van${count !== 1 ? "s" : ""}`;
  }

  function showLoading(show) {
    const spinner = document.getElementById("loading-spinner");
    const results = document.getElementById("search-results");

    if (show) {
      spinner.style.display = "block";
      results.style.display = "none";
    } else {
      spinner.style.display = "none";
      results.style.display = "block";
    }
  }

  function sortResults(sortBy) {
    // Implementation for sorting results
    console.log("Sorting by:", sortBy);
  }

  function toggleView(viewType) {
    const gridBtn = document.getElementById("grid-view");
    const listBtn = document.getElementById("list-view");
    const vansGrid = document.getElementById("vans-grid");

    if (viewType === "grid") {
      gridBtn.classList.add("active");
      listBtn.classList.remove("active");
      vansGrid.classList.remove("list-view");
    } else {
      listBtn.classList.add("active");
      gridBtn.classList.remove("active");
      vansGrid.classList.add("list-view");
    }
  }

  function saveSearch() {
    const saveFormData = new FormData(
      document.getElementById("save-search-form")
    );
    const searchFormData = new FormData(
      document.getElementById("advanced-search-form")
    );

    // Collect search criteria
    const searchCriteria = {};
    for (let [key, value] of searchFormData.entries()) {
      if (value) {
        searchCriteria[key] = value;
      }
    }

    // Add selected amenities
    const selectedAmenities = [];
    document
      .querySelectorAll('input[name="amenities"]:checked')
      .forEach((checkbox) => {
        selectedAmenities.push(checkbox.value);
      });

    if (selectedAmenities.length > 0) {
      searchCriteria.amenities = selectedAmenities;
    }

    const saveData = {
      search_name: saveFormData.get("search_name"),
      search_description: saveFormData.get("search_description"),
      search_criteria: searchCriteria,
      email_alerts: saveFormData.get("email_alerts") === "on",
    };

    fetch("/api/save-search", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(saveData),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Close modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("saveSearchModal")
          );
          modal.hide();

          // Reset form
          document.getElementById("save-search-form").reset();

          // Show success message
          showNotification("Search saved successfully!", "success");

          // Reload saved searches
          loadSavedSearches();
        } else {
          showNotification("Error saving search: " + data.error, "error");
        }
      })
      .catch((error) => {
        console.error("Error saving search:", error);
        showNotification("Error saving search", "error");
      });
  }

  function loadSavedSearches() {
    fetch("/api/saved-searches")
      .then((response) => response.json())
      .then((data) => {
        const savedSearchesList = document.getElementById(
          "saved-searches-list"
        );

        if (data.searches && data.searches.length > 0) {
          savedSearchesList.innerHTML = data.searches
            .map(
              (search) => `
            <div class="saved-search-item" data-search-id="${search.id}">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1" onclick="loadSavedSearch(${
                  search.id
                })">
                  <h6 class="mb-1">${search.name}</h6>
                  <p class="text-muted small mb-1">${
                    search.description || "No description"
                  }</p>
                  <div class="small text-muted">
                    <i class="fas fa-clock me-1"></i>
                    ${new Date(search.last_used).toLocaleDateString()}
                  </div>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSavedSearch(${
                  search.id
                })" title="Delete search">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `
            )
            .join("");
        } else {
          savedSearchesList.innerHTML =
            '<p class="text-muted small mb-0">No saved searches yet</p>';
        }
      })
      .catch((error) => {
        console.error("Error loading saved searches:", error);
      });
  }

  function loadSavedSearch(searchId) {
    fetch("/api/saved-searches")
      .then((response) => response.json())
      .then((data) => {
        const search = data.searches.find((s) => s.id === searchId);
        if (search && search.criteria) {
          // Populate form with saved criteria
          const form = document.getElementById("advanced-search-form");

          Object.keys(search.criteria).forEach((key) => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) {
              if (input.type === "checkbox") {
                input.checked = search.criteria[key].includes(input.value);
              } else {
                input.value = search.criteria[key];
              }
            }
          });

          // Handle amenities checkboxes
          if (search.criteria.amenities) {
            document
              .querySelectorAll('input[name="amenities"]')
              .forEach((checkbox) => {
                checkbox.checked = search.criteria.amenities.includes(
                  checkbox.value
                );
              });
          }

          // Perform search
          performSearch();
        }
      })
      .catch((error) => {
        console.error("Error loading saved search:", error);
      });
  }

  function deleteSavedSearch(searchId) {
    if (confirm("Are you sure you want to delete this saved search?")) {
      fetch(`/api/delete-saved-search/${searchId}`, {
        method: "DELETE",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showNotification("Search deleted successfully", "success");
            loadSavedSearches();
          } else {
            showNotification("Error deleting search: " + data.error, "error");
          }
        })
        .catch((error) => {
          console.error("Error deleting search:", error);
          showNotification("Error deleting search", "error");
        });
    }
  }

  function showNotification(message, type) {
    // Create a simple notification
    const notification = document.createElement("div");
    notification.className = `alert alert-${
      type === "success" ? "success" : "danger"
    } alert-dismissible fade show position-fixed`;
    notification.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 3000);
  }

  function toggleFavorite(vanId, button) {
    fetch("/api/toggle-favorite", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        van_id: parseInt(vanId),
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const icon = button.querySelector("i");

          if (data.is_favorited) {
            icon.classList.remove("far");
            icon.classList.add("fas");
            button.classList.add("text-danger");
            showNotification("Added to favorites", "success");
          } else {
            icon.classList.remove("fas");
            icon.classList.add("far");
            button.classList.remove("text-danger");
            showNotification("Removed from favorites", "success");
          }
        } else {
          showNotification("Error updating favorite: " + data.error, "error");
        }
      })
      .catch((error) => {
        console.error("Error toggling favorite:", error);
        showNotification("Error updating favorite", "error");
      });
  }
</script>
{% endblock %}
